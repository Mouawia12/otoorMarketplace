// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int        @id @default(autoincrement())
  email          String     @unique
  passwordHash   String     @map("password_hash")
  fullName       String     @map("full_name")
  phone          String?    @unique
  status         UserStatus @default(ACTIVE)
  avatarUrl      String?    @map("avatar_url")
  verifiedSeller Boolean    @default(false) @map("verified_seller")
  requiresPasswordReset Boolean @default(false) @map("requires_password_reset")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  roles        UserRole[]
  products     Product[]      @relation("SellerProducts")
  auctions     Auction[]      @relation("SellerAuctions")
  bids         Bid[]          @relation("UserBids")
  orders       Order[]        @relation("BuyerOrders")
  WishlistItem      WishlistItem[]
  Address           Address[]
  ProductTemplate   ProductTemplate[]
  reviews           ProductReview[]
  supportTickets    SupportTicket[]
  supportReplies    SupportReply[]
  sellerProfile     SellerProfile?
  sellerStatus      SellerStatus   @default(PENDING) @map("seller_status")
  passwordResetTokens PasswordResetToken[]
  coupons         Coupon[]
  updatedFooterPages   FooterPage[] @relation("FooterPageUpdatedBy")
  publishedFooterPages FooterPage[] @relation("FooterPagePublishedBy")
  notifications   Notification[]
  adminAuditLogs  AdminAuditLog[] @relation("AdminAuditLogAdmin")
  perfumeImportJobs PerfumeImportJob[]
}

model Role {
  id        Int        @id @default(autoincrement())
  name      RoleName   @unique
  users     UserRole[]
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
}

model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Product {
  id            Int              @id @default(autoincrement())
  sellerId      Int              @map("seller_id")
  nameAr        String           @map("name_ar")
  nameEn        String           @map("name_en")
  slug          String           @unique
  descriptionAr String           @map("description_ar") @db.Text
  descriptionEn String           @map("description_en") @db.Text
  productType   String           @map("product_type")
  brand         String
  category      String
  basePrice     Decimal          @map("base_price") @db.Decimal(10, 2)
  sizeMl        Int              @map("size_ml")
  concentration String
  condition     ProductCondition
  stockQuantity Int              @map("stock_quantity")
  isTester      Boolean          @default(false) @map("is_tester")
  status        ProductStatus    @default(DRAFT)
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  seller       User           @relation("SellerProducts", fields: [sellerId], references: [id], onDelete: Cascade)
  images       ProductImage[]
  auctions     Auction[]
  orderItems   OrderItem[]
  WishlistItem WishlistItem[]
  reviews      ProductReview[]

  @@index([sellerId])
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  url       String
  altText   String?  @map("alt_text")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model Auction {
  id               Int           @id @default(autoincrement())
  productId        Int           @unique @map("product_id")
  sellerId         Int           @map("seller_id")
  startingPrice    Decimal       @map("starting_price") @db.Decimal(10, 2)
  currentPrice     Decimal       @map("current_price") @db.Decimal(10, 2)
  minimumIncrement Decimal       @map("minimum_increment") @db.Decimal(10, 2)
  startTime        DateTime      @map("start_time")
  endTime          DateTime      @map("end_time")
  status           AuctionStatus @default(PENDING_REVIEW)
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  seller  User    @relation("SellerAuctions", fields: [sellerId], references: [id], onDelete: Cascade)
  bids    Bid[]
}

model Bid {
  id        Int      @id @default(autoincrement())
  auctionId Int      @map("auction_id")
  bidderId  Int      @map("bidder_id")
  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bidder  User    @relation("UserBids", fields: [bidderId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([bidderId])
}

model Order {
  id              Int         @id @default(autoincrement())
  buyerId         Int         @map("buyer_id")
  couponId        Int?        @map("coupon_id")
  couponCode      String?     @map("coupon_code")
  status          OrderStatus @default(PENDING)
  paymentMethod   String      @map("payment_method")
  shippingMethod  String      @map("shipping_method") @default("standard")
  shippingName    String      @map("shipping_name")
  shippingPhone   String      @map("shipping_phone")
  shippingCity    String      @map("shipping_city")
  shippingRegion  String      @map("shipping_region")
  shippingAddress String      @map("shipping_address")
  customerCityCode String?    @map("customer_city_code")
  customerCountry  String?    @map("customer_country")
  subtotalAmount  Decimal     @map("subtotal_amount") @db.Decimal(10, 2)
  discountAmount  Decimal     @map("discount_amount") @db.Decimal(10, 2)
  shippingFee     Decimal     @map("shipping_fee") @db.Decimal(10, 2)
  totalAmount     Decimal     @map("total_amount") @db.Decimal(10, 2)
  platformFee     Decimal     @map("platform_fee") @db.Decimal(10, 2) @default(0)
  codAmount       Decimal?    @map("cod_amount") @db.Decimal(10, 2)
  codCurrency     String?     @map("cod_currency")
  redboxPointId   String?     @map("redbox_point_id")
  redboxShipmentId String?    @map("redbox_shipment_id")
  redboxTrackingNumber String? @map("redbox_tracking_number")
  redboxLabelUrl  String?     @map("redbox_label_url")
  redboxStatus    String?     @map("redbox_status")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  buyer User        @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  coupon Coupon?    @relation(fields: [couponId], references: [id])
  items OrderItem[]
  reviews ProductReview[]

  @@index([buyerId])
  @@index([couponId])
  @@index([redboxShipmentId])
  @@index([redboxTrackingNumber])
}

model OrderItem {
  id         Int      @id @default(autoincrement())
  orderId    Int      @map("order_id")
  productId  Int      @map("product_id")
  quantity   Int
  unitPrice  Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal  @map("total_price") @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model WishlistItem {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  productId Int      @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int              @map("user_id")
  type      NotificationType @default(SYSTEM)
  title     String
  message   String
  data      Json?
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@map("notifications")
}

model Address {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  label     String
  recipient String
  phone     String
  city      String
  region    String
  street    String
  building  String?
  notes     String?
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model ProductTemplate {
  id            Int      @id @default(autoincrement())
  nameAr        String   @map("name_ar")
  nameEn        String   @map("name_en")
  descriptionAr String   @map("description_ar") @db.Text
  descriptionEn String   @map("description_en") @db.Text
  productType   String   @map("product_type")
  brand         String
  category      String
  basePrice     Decimal  @map("base_price") @db.Decimal(10, 2)
  sizeMl        Int      @map("size_ml")
  concentration String
  createdById   Int      @map("created_by_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  createdBy User                    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  images   ProductTemplateImage[]

  @@map("product_templates")
}

model ProductTemplateImage {
  id         Int      @id @default(autoincrement())
  templateId Int      @map("template_id")
  url        String
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  template ProductTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("product_template_images")
}

model Perfume {
  id             Int      @id @default(autoincrement())
  sourceUrl      String?  @unique @map("source_url")
  nameEn         String   @map("name_en")
  nameAr         String?  @map("name_ar")
  brand          String
  brandAr        String?  @map("brand_ar")
  ingredients    Json?
  ingredientsAr  Json?    @map("ingredients_ar")
  family         String?
  familyAr       String?  @map("family_ar")
  subFamily      String?  @map("sub_family")
  subFamilyAr    String?  @map("sub_family_ar")
  descriptionEn  String?  @map("description_en") @db.Text
  descriptionAr  String?  @map("description_ar") @db.Text
  perfumeClass   String?  @map("class")
  perfumer       String?
  price          Decimal? @db.Decimal(10, 2)
  origin         String?
  originAr       String?  @map("origin_ar")
  gender         String?
  genderAr       String?  @map("gender_ar")
  year           Int?
  concepts       Json?
  conceptsAr     Json?    @map("concepts_ar")
  imageLink      String?  @map("image_link")
  imageName      String?  @map("image_name")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([nameEn, brand, year])
  @@index([nameEn])
  @@index([brand])
  @@index([gender])
  @@index([family])
  @@index([year])
  @@map("perfumes")
}

model PerfumeImportJob {
  id              Int                 @id @default(autoincrement())
  status          PerfumeImportStatus @default(QUEUED)
  mode            PerfumeImportMode
  originalFilename String            @map("original_filename")
  storedFilename  String             @map("stored_filename")
  filePath        String             @map("file_path")
  totalRows       Int                @default(0) @map("total_rows")
  processedRows   Int                @default(0) @map("processed_rows")
  insertedRows    Int                @default(0) @map("inserted_rows")
  updatedRows     Int                @default(0) @map("updated_rows")
  skippedRows     Int                @default(0) @map("skipped_rows")
  failedRows      Int                @default(0) @map("failed_rows")
  errorCount      Int                @default(0) @map("error_count")
  errorFilePath   String?            @map("error_file_path")
  errorSamples    Json?              @map("error_samples")
  downloadImages  Boolean            @default(false) @map("download_images")
  createdById     Int?               @map("created_by_id")
  startedAt       DateTime?          @map("started_at")
  finishedAt      DateTime?          @map("finished_at")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([status])
  @@map("perfume_import_jobs")
}

model Setting {
  key       String   @id
  value     Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model AdminAuditLog {
  id          Int      @id @default(autoincrement())
  adminId     Int      @map("admin_id")
  actorType   String   @map("actor_type") @default("admin")
  action      String
  targetType  String   @map("target_type")
  targetId    Int?     @map("target_id")
  description String?  @db.Text
  metadata    Json?
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  admin User @relation("AdminAuditLogAdmin", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetType, targetId])
  @@map("admin_audit_logs")
}

model ProductReview {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  userId    Int      @map("user_id")
  orderId   Int      @map("order_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, orderId])
  @@index([productId])
  @@map("product_reviews")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum RoleName {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  SUPPORT
  SELLER
  BUYER
}

enum ProductCondition {
  NEW
  USED
}

enum ProductStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  REJECTED
  ARCHIVED
}

enum PostStatus {
  DRAFT
  PUBLISHED
}

enum PostLang {
  AR
  EN
}

enum PerfumeImportStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

enum PerfumeImportMode {
  INSERT_ONLY
  UPSERT
  REPLACE
}

model Post {
  id          Int        @id @default(autoincrement())
  title       String
  slug        String     @unique
  description String   @db.Text
  coverUrl    String     @map("cover_url")
  author      String
  category    String?
  tags        String?
  content     String   @db.LongText
  status      PostStatus @default(DRAFT)
  lang        PostLang
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
}

enum AuctionStatus {
  PENDING_REVIEW
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum SupportStatus {
  OPEN
  PENDING
  ANSWERED
  CLOSED
}

enum SellerStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  SYSTEM
  USER_REGISTERED
  PRODUCT_SUBMITTED
  PRODUCT_APPROVED
  PRODUCT_REJECTED
  SELLER_APPLICATION_SUBMITTED
  SELLER_APPLICATION_APPROVED
  SELLER_APPLICATION_REJECTED
}

model SupportTicket {
  id         Int           @id @default(autoincrement())
  userId     Int
  subject    String
  message    String
  status     SupportStatus @default(OPEN)
  role       String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  user       User          @relation(fields: [userId], references: [id])
  replies    SupportReply[]
}

model SupportReply {
  id         Int      @id @default(autoincrement())
  ticketId   Int
  userId     Int
  message    String
  createdAt  DateTime @default(now())
  ticket     SupportTicket @relation(fields: [ticketId], references: [id])
  user       User          @relation(fields: [userId], references: [id])
}

model SellerProfile {
  id              Int           @id @default(autoincrement())
  userId          Int           @unique
  fullName        String
  phone           String
  city            String
  address         String
  nationalId      String
  iban            String
  bankName        String
  status          SellerStatus  @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  user            User          @relation(fields: [userId], references: [id])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

model Coupon {
  id            Int                 @id @default(autoincrement())
  code          String              @unique
  discountType  CouponDiscountType  @map("discount_type")
  discountValue Decimal             @map("discount_value") @db.Decimal(10, 2)
  sellerId      Int?                @map("seller_id")
  expiresAt     DateTime?           @map("expires_at")
  maxUsage      Int?                @map("max_usage")
  usageCount    Int                 @default(0) @map("usage_count")
  isActive      Boolean             @default(true) @map("is_active")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  orders Order[]
  seller User? @relation(fields: [sellerId], references: [id])

  @@index([sellerId])
}

enum CouponDiscountType {
  PERCENTAGE
  FIXED
}

enum PromotionType {
  HERO
  STRIP
  FLOATING
}

enum FooterPageStatus {
  DRAFT
  PUBLISHED
}

model FooterPage {
  id               Int               @id @default(autoincrement())
  slug             String            @unique
  draftContent     Json              @map("draft_content")
  publishedContent Json?             @map("published_content")
  status           FooterPageStatus  @default(DRAFT)
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  publishedAt      DateTime?         @map("published_at")
  updatedById      Int?              @map("updated_by_id")
  publishedById    Int?              @map("published_by_id")

  updatedBy   User? @relation("FooterPageUpdatedBy", fields: [updatedById], references: [id])
  publishedBy User? @relation("FooterPagePublishedBy", fields: [publishedById], references: [id])
}

model Promotion {
  id               Int            @id @default(autoincrement())
  type             PromotionType  @default(HERO)
  titleEn          String         @map("title_en")
  titleAr          String         @map("title_ar")
  subtitleEn       String?        @map("subtitle_en")
  subtitleAr       String?        @map("subtitle_ar")
  descriptionEn    String?        @map("description_en")
  descriptionAr    String?        @map("description_ar")
  badgeTextEn      String?        @map("badge_text_en")
  badgeTextAr      String?        @map("badge_text_ar")
  buttonTextEn     String?        @map("button_text_en")
  buttonTextAr     String?        @map("button_text_ar")
  imageUrl         String?        @map("image_url")
  linkUrl          String?        @map("link_url")
  backgroundColor  String?        @default("#0f172a") @map("background_color")
  textColor        String?        @default("#ffffff") @map("text_color")
  floatingPosition String?        @map("floating_position")
  isActive         Boolean        @default(true) @map("is_active")
  sortOrder        Int            @default(0) @map("sort_order")
  startAt          DateTime?      @map("start_at")
  endAt            DateTime?      @map("end_at")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
}
